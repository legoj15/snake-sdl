name: build

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'


jobs:
  build-windows:
    name: Windows (Release)
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_TARGET_TRIPLET: x64-windows-static
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake + Ninja
        uses: lukka/get-cmake@latest

      - name: Setup Python (Windows)
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup MSVC (Windows)
        uses: ilammy/msvc-dev-cmd@v1

      - name: De-Mingw PATH (Windows)
        shell: pwsh
        run: |
          $p = $env:Path -split ';' | Where-Object { $_ -notmatch 'mingw64\\bin' }
          "Path=$($p -join ';')" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Setup vcpkg (manifest mode + caching)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: '**/vcpkg.json'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'

      - name: Build (Windows)
        shell: cmd
        run: |
          set PYTHON_BIN=python
          build-windows.bat release

      - name: Verify layout
        shell: pwsh
        run: |
          if (!(Test-Path "build\\launcher.exe")) { throw "Missing build\\launcher.exe" }
          if (!(Test-Path "build\\snakebot.dll")) { throw "Missing build\\snakebot.dll" }
          if (!(Test-Path "build\\game\\snake.exe")) { throw "Missing build\\game\\snake.exe" }
          if (!(Test-Path "build\\game\\assets\\bgm.wav")) { throw "Missing build\\game\\assets\\bgm.wav" }

      - name: Stage package (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $pkg = "dist\\package-windows"
          if (Test-Path $pkg) { Remove-Item -Recurse -Force $pkg }
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          $exclude = @(
            "CMakeFiles",
            "vcpkg_installed",
            "build.ninja",
            "CMakeCache.txt",
            "cmake_install.cmake",
            "compile_commands.json",
            ".ninja_deps",
            ".ninja_log",
            "vcpkg-manifest-install.log",
            "game",
            "snakebot.dll",
            "readme.txt"
          )
          Get-ChildItem "build" | Where-Object {
            $exclude -notcontains $_.Name -and $_.Extension -notin @(".zip", ".lib", ".exp") -and $_.Name -notlike "*.build"
          } |
            ForEach-Object { Copy-Item $_.FullName $pkg -Recurse }
          Copy-Item "build\\game" $pkg -Recurse
          Copy-Item "build\\snakebot.dll" $pkg
          if (Test-Path "build\\readme.txt") { Copy-Item "build\\readme.txt" $pkg }

      - name: Upload artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: snake-windows
          path: dist/package-windows

  build-linux:
    name: Linux (Release)
    runs-on: ubuntu-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_TARGET_TRIPLET: x64-linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux build deps (Ubuntu)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            autoconf autoconf-archive automake libtool \
            pkg-config \
            python3-venv python3-dev python3-tk patchelf libltdl-dev \
            libx11-dev libxext-dev libxrandr-dev libxrender-dev libxss-dev \
            libxcursor-dev libxi-dev libxinerama-dev libxkbcommon-dev \
            libsm-dev libice-dev \
            libxtst-dev \
            libwayland-dev wayland-protocols libdecor-0-dev \
            libegl1-mesa-dev libgl1-mesa-dev \
            libasound2-dev libpulse-dev libpipewire-0.3-dev libjack-jackd2-dev \
            libogg-dev libvorbis-dev libopusfile-dev

      - name: Setup CMake + Ninja
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg (manifest mode + caching)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: '**/vcpkg.json'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'

      - name: Build (Linux)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x build.sh
          ./build.sh release

      - name: Verify layout
        shell: bash
        run: |
          set -euo pipefail
          test -f build/launcher
          test -f build/libsnakebot.so
          test -f build/game/snake
          test -f build/game/assets/bgm.wav

      - name: Stage package (Linux)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist/package-linux
          mkdir -p dist/package-linux
          for entry in build/*; do
            name="$(basename "$entry")"
            case "$name" in
              CMakeFiles|vcpkg_installed|build.ninja|CMakeCache.txt|cmake_install.cmake|compile_commands.json|.ninja_deps|.ninja_log|vcpkg-manifest-install.log|game|libsnakebot.so|readme.txt|*.zip|*.build)
                continue
                ;;
            esac
            cp -a "$entry" dist/package-linux/
          done
          cp -a build/game dist/package-linux/
          cp -a build/libsnakebot.so dist/package-linux/
          if [ -f build/readme.txt ]; then cp -a build/readme.txt dist/package-linux/; fi

      - name: Upload artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: snake-linux
          path: dist/package-linux

  release:
    name: Release
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Verify artifacts downloaded
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d dist ]; then
            echo "No artifacts directory created. Check that build jobs uploaded artifacts."
            exit 1
          fi
          if [ -z "$(find dist -mindepth 1 -maxdepth 1 -type d -print -quit)" ]; then
            echo "No artifacts were downloaded into dist/. Check that build jobs produced artifacts."
            exit 1
          fi

      - name: Install zip (Release)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Package zips (Release)
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          SAFE_TAG="${GITHUB_REF_NAME//./_}"
          WIN_ZIP="snake-windows-${SAFE_TAG}.zip"
          LINUX_ZIP="snake-linux-${SAFE_TAG}.zip"
          if [ -d snake-linux ]; then
            chmod +x snake-linux/launcher snake-linux/game/snake || true
          fi
          if [ -d snake-windows ]; then
            (cd snake-windows && zip -r "../${WIN_ZIP}" .)
          fi
          if [ -d snake-linux ]; then
            (cd snake-linux && zip -r "../${LINUX_ZIP}" .)
          fi

      - name: Extract changelog for release
        shell: bash
        run: |
          set -euo pipefail
          RAW_TAG="${GITHUB_REF_NAME}"
          VER="${RAW_TAG#v}"

          echo "Extracting changelog for tag '$RAW_TAG' (version '$VER')"
          echo "Changelog headings found:"
          grep -nE '^## \[' CHANGELOG.md || true

          awk -v ver="$VER" -v tag="$RAW_TAG" '
            BEGIN { found=0 }
            {
              line=$0
              if (!found && (line ~ ("^## \\[" ver "\\]") || line ~ ("^## \\[" tag "\\]"))) {
                found=1
              } else if (found && line ~ "^## \\[") {
                exit
              }
              if (found) print
            }
          ' CHANGELOG.md > RELEASE_NOTES.md

          test -s RELEASE_NOTES.md

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/snake-windows-*.zip
            dist/snake-linux-*.zip
          body_path: RELEASE_NOTES.md
