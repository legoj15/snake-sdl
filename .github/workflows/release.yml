name: release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find build workflow run
        id: find_build_run
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const headSha = context.sha;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: "build.yml",
              head_sha: headSha,
              status: "completed",
              per_page: 10
            });
            const match = runs.data.workflow_runs.find(run => run.conclusion === "success");
            if (!match) {
              core.setFailed(`No successful build.yml run found for sha ${headSha}`);
              return;
            }
            core.setOutput("run_id", match.id.toString());

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.find_build_run.outputs.run_id }}
          path: dist

      - name: Install zip (Release)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Package zips (Release)
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          if [ -d snake-linux ]; then
            chmod +x snake-linux/launcher snake-linux/game/snake || true
          fi
          if [ -d snake-windows ]; then
            (cd snake-windows && zip -r ../snake-windows.zip .)
          fi
          if [ -d snake-linux ]; then
            (cd snake-linux && zip -r ../snake-linux.zip .)
          fi

      - name: Extract changelog for release
        shell: bash
        run: |
          set -euo pipefail
          RAW_TAG="${GITHUB_REF_NAME}"
          VER="${RAW_TAG#v}"

          echo "Extracting changelog for tag '$RAW_TAG' (version '$VER')"
          echo "Changelog headings found:"
          grep -nE '^## \[' CHANGELOG.md || true

          awk -v ver="$VER" -v tag="$RAW_TAG" '
            BEGIN { found=0 }
            {
              line=$0
              if (!found && (line ~ ("^## \\[" ver "\\]") || line ~ ("^## \\[" tag "\\]"))) {
                found=1
              } else if (found && line ~ "^## \\[") {
                exit
              }
              if (found) print
            }
          ' CHANGELOG.md > RELEASE_NOTES.md

          test -s RELEASE_NOTES.md

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/snake-windows.zip
            dist/snake-linux.zip
          body_path: RELEASE_NOTES.md
